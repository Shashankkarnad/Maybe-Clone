<%# locals: (category:, categories:) %>

<div data-controller="color-avatar">
  <%= styled_form_with model: category, class: "space-y-4" do |f| %>
    <section class="space-y-4">
      <details>
        <summary>
          <div class="w-fit m-auto">
            <%= render partial: "shared/color_avatar", locals: { name: category.name, color: category.color } %>
          </div>
        </summary>

        <div class=" absolute z-50 bg-white p-4 border border-alpha-black-25 rounded-2xl shadow-xs h-fit left-62" data-controller="color-picker">
          <div class="flex gap-2 flex-col mb-4" data-color-avatar-target="selection">
            <div data-color-picker-target="pickerSection"></div>
            <h4 class="text-gray-500 text-sm">Color</h4>
            <div class="flex gap-2 items-center" data-color-picker-target="colorsSection">
              <% Category::COLORS.each do |color| %>
                <label class="relative">
                  <%= f.radio_button :color, color, class: "sr-only peer", data: { action: "change->color-picker#handleColorChange change->color-avatar#handleColorChange" } %>
                  <div class="w-6 h-6 rounded-full cursor-pointer peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-blue-500" style="background-color: <%= color %>"></div>
                </label>
              <% end %>
              <div class="w-6 h-6 rounded-full cursor-pointer" data-color-picker-target="pickerBtn" style="background: conic-gradient(red,orange,yellow,lime,green,teal,cyan,blue,indigo,purple,magenta,pink,red)" ></div>
            </div>
            <div class="flex gap-2 items-center hidden flex-col" data-color-picker-target="paletteSection">
              <div class="flex gap-2 items-center w-full">
                <div class="w-6 h-6 p-4 rounded-full cursor-pointer" style="background-color: <%= category.color %>" data-color-picker-target="colorPreview"></div>
                <%= f.text_field :color , data: { color_picker_target: "colorInput", color_avatar_target: "colorInput", color_picker_color_value: "color" }, class: "form-field__input w-auto" %>
                <%= lucide_icon "palette", class: "w-8 h-8 cursor-pointer hover:bg-gray-100 p-1", data: { action: "click->color-picker#toggleSections" } %>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 justify-center flex-col w-87">
            <h4 class="text-gray-500 text-sm">Icon</h4>
            <div class="flex flex-wrap gap-2 mb-4">
              <% Category.icon_codes.each do |icon| %>
                <label class="relative">
                  <%= f.radio_button :lucide_icon, icon, class: "sr-only peer", data: { action: "change->color-avatar#handleIconChange" } %>
                  <div class="w-6 h-6 rounded cursor-pointer hover:bg-gray-100 peer-checked:bg-gray-100 border-1 border-transparent ">
                    <%= lucide_icon icon, class: "w-6 h-6 p-1" %>
                  </div>
                </label>
              <% end %>
            </div>
          </div>
        </div>
      </details>

      <% if category.errors.any? %>
        <%= render "shared/form_errors", model: category %>
      <% end %>

      <div class="space-y-2">
        <%= f.select :classification, [["Income", "income"], ["Expense", "expense"]], { label: "Classification" }, required: true %>
        <%= f.text_field :name, placeholder: t(".placeholder"), required: true, autofocus: true, label: "Name", data: { color_avatar_target: "name" } %>
        <% unless category.parent? %>
          <%= f.select :parent_id, categories.pluck(:name, :id), { include_blank: "(unassigned)", label: "Parent category (optional)" }, disabled: category.parent?, data: { action: "change->color-avatar#handleParentChange" } %>
        <% end %>
      </div>
    </section>

    <section>
      <%= hidden_field_tag :transaction_id, params[:transaction_id] %>
      <%= f.submit %>
    </section>
  <% end %>
</div>
